//
//  CampusMapViewController.swift
//  MackTIA
//
//  Created by Joaquim Pessoa Filho on 19/08/16.
//  Copyright (c) 2016 Mackenzie. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so you can apply
//  clean architecture to your iOS and Mac projects, see http://clean-swift.com
//

import UIKit
import MapKit



class CampusMapViewController: UIViewController {
    @IBOutlet weak var mapView: MKMapView!
    
    // MARK: Object lifecycle
    
    override func awakeFromNib() {
        super.awakeFromNib()
    }
    
    // MARK: View lifecycle
    
    override func viewDidLoad() {
        super.viewDidLoad()
        loadPinAnnotations()
    }
    
    // MARK: Event handling
    
    func loadPinAnnotations() {
        
        let filePath = NSBundle.mainBundle().pathForResource("CampusMap", ofType: "plist")
        let properties = NSArray(contentsOfFile: filePath!)
        
        // Set MapView Region
        // -23.546954, -46.651796
        let centerCoordinate = CLLocationCoordinate2D(latitude: CLLocationDegrees(-23.546954), longitude: CLLocationDegrees(-46.651796))
        let region = MKCoordinateRegionMakeWithDistance(centerCoordinate, 600, 600)
        mapView.setRegion(region, animated: false)
        
        // Add Map Annotation
        for item in properties! {
            if let newPinData = item as? Dictionary<String,String>{
                let point = CGPointFromString(newPinData["location"]!)
                let coordinate = CLLocationCoordinate2D(latitude: CLLocationDegrees(point.x), longitude: CLLocationDegrees(point.y))
                
                let annotation = CampusMapAnnotation(name: newPinData["name"]!, buildName: newPinData["buildName"]!, number: newPinData["number"]!, coordinate: coordinate)
                mapView.addAnnotation(annotation)
            }
        }
    }
    
    
}

// MARK: - Map View delegate

extension CampusMapViewController: MKMapViewDelegate {
    func mapView(mapView: MKMapView, viewForAnnotation annotation: MKAnnotation) -> MKAnnotationView? {
        
        guard let annotation = annotation as? CampusMapAnnotation else {
            print(#function, "Problem with CampusMapAnnotation NIB")
            return nil
        }
        
        let view = self.mapView.dequeueReusableAnnotationViewWithIdentifier("CampusMap") ?? CustomAnnotationView(annotation: annotation, reuseIdentifier: "CampusMap")
        
        let image = UIImage(named: "pin\(annotation.number)") ?? UIImage(named: "pinDefault")
        view.image = image
        view.enabled = true
        view.canShowCallout = true
        //        let imageAccessory = UIImageView(image: UIImage(named: "pinView45"))
        //        imageAccessory.contentMode = .ScaleAspectFit
        //        view.leftCalloutAccessoryView = imageAccessory
        
        return view
    }
    
//    func mapView(mapView: MKMapView, didSelectAnnotationView view: MKAnnotationView) {
//        
//        guard let annotation = view.annotation as? CampusMapAnnotation else {
//            print(#function, "Unknown annotation")
//            return
//        }
//        
//        guard view.subviews.count == 0 else {
//            for subview in view.subviews {
//                subview.removeFromSuperview()
//            }
//            return
//        }
//        
//        guard let customView = NSBundle.mainBundle().loadNibNamed("CampusMapAnnotation", owner: self, options: nil)[0] as? CampusMapAnnotationView else {
//            print(#function, "Problem in loadNibNamed for 'CampusMapAnnotation' id")
//            return
//        }
//        
//        customView.buildName.text = annotation.buildName
//        customView.name.text = annotation.name
//        customView.number.text = annotation.number
//        
//        customView.frame.origin = CGPointMake(-customView.frame.size.width/2 + 15, -customView.frame.size.height)
//        
//        view.addSubview(customView)
//        
////        self.mapView.centerCoordinate = annotation.coordinate
//    }
//    
//    func mapView(mapView: MKMapView, didDeselectAnnotationView view: MKAnnotationView) {
//        if view.isKindOfClass(CustomAnnotationView) {
//            for subview in view.subviews {
//                subview.removeFromSuperview()
//            }
//        }
//    }
}
