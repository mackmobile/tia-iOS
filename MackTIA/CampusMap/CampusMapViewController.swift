//
//  CampusMapViewController.swift
//  MackTIA
//
//  Created by Joaquim Pessoa Filho on 19/08/16.
//  Copyright (c) 2016 Mackenzie. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so you can apply
//  clean architecture to your iOS and Mac projects, see http://clean-swift.com
//

import UIKit
import MapKit
import Polyline



class CampusMapViewController: UIViewController {
    @IBOutlet weak var mapView: MKMapView!
    let locationManager = CLLocationManager()
    var locValue: CLLocationCoordinate2D?
    var retryDestination: CLLocationCoordinate2D?
    let centerCoordinate = CLLocationCoordinate2D(latitude: CLLocationDegrees(-23.546954), longitude: CLLocationDegrees(-46.651796))
    var routeOverlay: MKPolyline?
    
    var flag = false
    
    // MARK: Object lifecycle
    
    override func awakeFromNib() {
        super.awakeFromNib()
    }
    
    // MARK: View lifecycle
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        self.locationManager.desiredAccuracy = kCLLocationAccuracyBest
        let authstate = CLLocationManager.authorizationStatus()
        if(authstate == CLAuthorizationStatus.NotDetermined){
            print("Not Authorised")
            locationManager.requestWhenInUseAuthorization()
        }
        
        loadPinAnnotations()
        loadRegions()
        
    }
    
    // MARK: Event handling
    
    func loadPinAnnotations() {
        
        let filePath = NSBundle.mainBundle().pathForResource("CampusMap", ofType: "plist")
        let properties = NSArray(contentsOfFile: filePath!)
        
        // Set MapView Region
        // -23.546954, -46.651796
        let region = MKCoordinateRegionMakeWithDistance(centerCoordinate, 600, 600)
        mapView.setRegion(region, animated: false)
        
        // Add Map Annotation
        for item in properties! {
            if let newPinData = item as? Dictionary<String,String>{
                let point = CGPointFromString(newPinData["location"]!)
                let coordinate = CLLocationCoordinate2D(latitude: CLLocationDegrees(point.x), longitude: CLLocationDegrees(point.y))
                
                let annotation = CampusMapAnnotation(name: newPinData["name"]!, buildName: newPinData["buildName"]!, number: newPinData["number"]!, coordinate: coordinate, color: newPinData["color"]!)
                mapView.addAnnotation(annotation)
            }
        }
    }
    
    func loadRegions() {
        
        let filePath = NSBundle.mainBundle().pathForResource("CampusMapRegions", ofType: "plist")
        let properties = NSArray(contentsOfFile: filePath!)
        
        // Add Map Annotation
        for item in properties! {
            if let newPinData = item as? [String: String] {
                let region = CampusMapRegion(name: newPinData["name"]!, polylineString: newPinData["polylineString"]!, color: newPinData["color"]!)
                self.mapView.addOverlay(region)
            }
        }
    }
    
    func traceRouteTo(buildName buildName: String) {
        let filePath = NSBundle.mainBundle().pathForResource("CampusMap", ofType: "plist")
        let buildNameFormatted = String(Int(buildName) ?? 0)
        let properties = NSArray(contentsOfFile: filePath!) as! [[String: String]]
        if let destination = properties.filter({$0["number"] == buildNameFormatted}).first {
            let point = CGPointFromString(destination["location"]!)
            let coordinate = CLLocationCoordinate2D(latitude: CLLocationDegrees(point.x), longitude: CLLocationDegrees(point.y))
            traceRouteTo(coordinate: coordinate)
        } else {
            let alert = UIAlertController(title: NSLocalizedString("campusmap_errorBuildNotFoundTitle", comment: "Too far away"), message: String(format: NSLocalizedString("campusmap_errorBuildNotFoundMessage", comment: "Too far away"), buildName), preferredStyle: .Alert)
            alert.addAction(UIAlertAction(title: "OK", style: .Default, handler: nil))
            self.presentViewController(alert, animated: true, completion: nil)
        }
    }
    
    func traceRouteTo(coordinate destination: CLLocationCoordinate2D) {
        if let origin = locValue {
            if CLLocation(location: origin).distanceFromLocation(CLLocation(location: destination)) > 3000 {
                let alert = UIAlertController(title: NSLocalizedString("campusmap_errorTooFarAwayTitle", comment: "Too far away"), message: NSLocalizedString("campusmap_errorTooFarAwayMessage", comment: "Too far away"), preferredStyle: .Alert)
                alert.addAction(UIAlertAction(title: "OK", style: .Default, handler: nil))
                self.presentViewController(alert, animated: true, completion: nil)
                return
            }
            DirectionsAPI.sharedInstance.getPolyline(origin, destination: destination) { (polylineEncoded, error) in
                if (error == nil && polylineEncoded != nil) {
                    guard let coordinates: [CLLocationCoordinate2D] = decodePolyline(polylineEncoded!) else {
                        return
                    }
                    var waypoints = coordinates
                    waypoints.insert(origin, atIndex: 0)
                    waypoints.append(destination)
                    let myPolyline = MKPolyline(coordinates: &waypoints, count: waypoints.count)
                    if self.routeOverlay != nil {
                        if self.mapView.overlays.contains(self.routeOverlay!) {
                            self.mapView.removeOverlays([self.routeOverlay!])
                        }
                    }
                    self.routeOverlay = myPolyline
                    self.mapView.addOverlay(myPolyline)
                }
                
            }
        } else {
            retryDestination = destination
        }
    }

}

// MARK: - Map View delegate

extension CampusMapViewController: MKMapViewDelegate {
    func mapView(mapView: MKMapView, viewForAnnotation annotation: MKAnnotation) -> MKAnnotationView? {
        
        guard let annotation = annotation as? CampusMapAnnotation else {
            print(#function, "Problem with CampusMapAnnotation NIB")
            return nil
        }
        
        let view = self.mapView.dequeueReusableAnnotationViewWithIdentifier("CampusMap") ?? MKAnnotationView(annotation: annotation, reuseIdentifier: "CampusMap")
        
        let img =  UIImage(named: "pin")!.insertText(text: annotation.number, size: 16.0, offset: 0.2, color: annotation.color)
        
        view.image = img
        view.enabled = true
        view.canShowCallout = true
        view.centerOffset = CGPoint(x: 0, y: -img.size.height/2)
        
        return view
    }
    
    func mapView(mapView: MKMapView, didSelectAnnotationView view: MKAnnotationView) {
        traceRouteTo(coordinate: view.annotation!.coordinate)
    }

    func mapView(mapView: MKMapView, rendererForOverlay overlay: MKOverlay) -> MKOverlayRenderer {
        if overlay is MKPolyline {
            let lineView = MKPolylineRenderer(overlay: overlay)
            lineView.strokeColor = UIColor.redColor()
            lineView.lineWidth = 2;
            
            return lineView
        } else if let region = overlay as? CampusMapRegion {
            let polygonView = MKPolygonRenderer(overlay: overlay)
            polygonView.lineWidth = 2;
            polygonView.strokeColor = region.strokeColor
            polygonView.fillColor = region.fillColor
            
            return polygonView
        }
        return MKPolylineRenderer()
    }
    
    func mapView(mapView: MKMapView, didUpdateUserLocation userLocation: MKUserLocation) {
        locValue = userLocation.coordinate
        if retryDestination != nil {
            traceRouteTo(coordinate: retryDestination!)
            retryDestination = nil
        }
    }
    
    func mapView(mapView: MKMapView, regionDidChangeAnimated animated: Bool) {
        if flag {
            flag = false
            return
        }
        let centerLocation = CLLocation(location: centerCoordinate)
        let centerMapView = CLLocation(location: mapView.centerCoordinate)
        if mapView.camera.altitude > 1500.00 {
            let region = MKCoordinateRegionMakeWithDistance(centerCoordinate, 600, 600)
            mapView.setRegion(region, animated: true)
            flag = true
        }
        if centerLocation.distanceFromLocation(centerMapView) > 600.00 {
            
            let span = mapView.region.span
            let region = MKCoordinateRegionMake(centerCoordinate, span)
            mapView.setRegion(region, animated: true)
            flag = true
        }
    }
}
